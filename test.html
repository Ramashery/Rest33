<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Firebase Connection Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; margin-top: 10px; }
        .btn-create { background-color: #007bff; }
        .btn-login { background-color: #ffc107; color: black; }
        .btn-read { background-color: #28a745; }
        input { width: 95%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #logOutput { background-color: #333; color: #0f0; padding: 15px; border-radius: 5px; margin-top: 20px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto; }
        #loginStatus { font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Диагностика подключения к Firebase</h1>
        <p>Эта страница поможет выяснить, почему бронирования не создаются или не отображаются.</p>

        <h2>Тест 1: Создание бронирования (как обычный пользователь)</h2>
        <p>Нажмите, чтобы попытаться создать тестовое бронирование. Это имитирует действие на `index.html`.</p>
        <button id="createBookingBtn" class="btn-create">1. Создать тестовое бронирование</button>

        <hr style="margin: 20px 0;">

        <h2>Тест 2 и 3: Вход и чтение (как администратор)</h2>
        <p>Войдите под одним из аккаунтов администратора, чтобы проверить, может ли админ-панель читать данные.</p>
        <div>
            <label for="email">Email администратора:</label>
            <input type="email" id="email" placeholder="admin@example.com">
        </div>
        <div>
            <label for="password">Пароль:</label>
            <input type="password" id="password">
        </div>
        <button id="loginBtn" class="btn-login">2. Войти как администратор</button>
        <div id="loginStatus">Статус: Не авторизован</div>

        <div id="admin-actions" style="display: none; margin-top: 20px;">
            <p>Теперь, когда вы вошли, попробуйте прочитать все бронирования.</p>
            <button id="readBookingsBtn" class="btn-read">3. Прочитать все бронирования (как админ)</button>
        </div>

        <h2>Лог выполнения:</h2>
        <pre id="logOutput">Ожидание действий...</pre>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCZZ7kICCJMcWAjW5bnf_-vsH2s-KoZrSs",
            authDomain: "tbil-home.firebaseapp.com",
            projectId: "tbil-home",
            storageBucket: "tbil-home.firebasestorage.app",
            messagingSenderId: "849747940427",
            appId: "1:849747940427:web:bd3744d816a25e62c7e9ce",
            measurementId: "G-7YWSRMGV33"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const logOutput = document.getElementById('logOutput');
        const createBookingBtn = document.getElementById('createBookingBtn');
        const loginBtn = document.getElementById('loginBtn');
        const readBookingsBtn = document.getElementById('readBookingsBtn');
        const loginStatus = document.getElementById('loginStatus');
        const adminActions = document.getElementById('admin-actions');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        function log(message) {
            console.log(message);
            logOutput.textContent += `\n[${new Date().toLocaleTimeString()}] ${message}`;
        }

        // Тест 1: Создание бронирования
        createBookingBtn.addEventListener('click', () => {
            log('Начинаю Тест 1: Попытка создать тестовое бронирование...');
            const testBooking = {
                userName: "TEST BOOKING - DELETE ME",
                userEmail: "test@test.com",
                roomId: "test-room",
                checkInDate: "2025-01-01",
                checkOutDate: "2025-01-02",
                guests: 1,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('bookings').add(testBooking)
                .then((docRef) => {
                    log(`✅ УСПЕХ! Бронирование создано с ID: ${docRef.id}`);
                    log('Это означает, что правило "allow create" работает правильно. Проблема, скорее всего, в чтении данных админ-панелью.');
                })
                .catch((error) => {
                    log(`❌ ОШИБКА при создании бронирования!`);
                    log(`Код ошибки: ${error.code}`);
                    log(`Сообщение: ${error.message}`);
                    log('Это означает, что правила безопасности блокируют создание брони. Скопируйте эту ошибку и отправьте мне.');
                });
        });

        // Тест 2: Вход администратора
        loginBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                log('Введите email и пароль администратора.');
                return;
            }
            log(`Начинаю Тест 2: Попытка входа для ${email}...`);
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    log(`✅ УСПЕХ! Вход выполнен.`);
                    log(`Email: ${user.email}`);
                    log(`UID: ${user.uid}`);
                    loginStatus.textContent = `Статус: Авторизован как ${user.email}`;
                    adminActions.style.display = 'block';
                })
                .catch((error) => {
                    log(`❌ ОШИБКА входа!`);
                    log(`Код ошибки: ${error.code}`);
                    log(`Сообщение: ${error.message}`);
                });
        });

        // Тест 3: Чтение бронирований
        readBookingsBtn.addEventListener('click', () => {
            log('Начинаю Тест 3: Попытка прочитать все бронирования...');
            if (!auth.currentUser) {
                log('Ошибка: Сначала нужно войти как администратор.');
                return;
            }

            db.collection('bookings').get()
                .then((snapshot) => {
                    log(`✅ УСПЕХ! Получен список бронирований.`);
                    log(`Найдено документов: ${snapshot.size}`);
                    if (snapshot.size > 0) {
                        log('Это означает, что правила "allow list" и проверка "isAdmin" работают правильно.');
                        snapshot.forEach(doc => {
                            log(`  - ID: ${doc.id}, Имя: ${doc.data().userName}`);
                        });
                    } else {
                        log('Список пуст. Либо бронирований действительно нет, либо они были созданы с ошибкой.');
                    }
                })
                .catch((error) => {
                    log(`❌ ОШИБКА при чтении списка бронирований!`);
                    log(`Код ошибки: ${error.code}`);
                    log(`Сообщение: ${error.message}`);
                    log('Это означает, что правила безопасности блокируют чтение списка. Скопируйте эту ошибку и отправьте мне.');
                });
        });

    </script>
</body>
</html>